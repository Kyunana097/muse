C51 COMPILER V9.60.0.0   MUSIC                                                             04/29/2025 11:26:34 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE MUSIC
OBJECT MODULE PLACED IN .\Objects\music.obj
COMPILER INVOKED BY: D:\keil\C51\BIN\C51.EXE sources\music.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(.\Headers;.\sources) 
                    -DEBUG OBJECTEXTEND PRINT(.\Listings\music.lst) OBJECT(.\Objects\music.obj)

line level    source

   1          // Music.c
   2          #include "Music.h"
   3          #include "Delay.h"
   4          
   5          //播放速度，值为四分音符的时长(ms)   120 / 60 = 2 --> 1 / 2 * 1e3 = 500 ms
   6          //                                                                                                                               100 / 60     --> 60 / 100 * 1e3 = 600ms
   7          #define SPEED   300
   8          /*
   9          #define P       0
  10          #define L1      1
  11          #define L1_     2
  12          #define L2      3
  13          #define L2_     4
  14          #define L3      5
  15          #define L4      6
  16          #define L4_     7
  17          #define L5      8
  18          #define L5_     9
  19          #define L6      10
  20          #define L6_     11
  21          #define L7      12
  22          #define M1      13
  23          #define M1_     14
  24          #define M2      15
  25          #define M2_     16
  26          #define M3      17
  27          #define M4      18
  28          #define M4_     19
  29          #define M5      20
  30          #define M5_     21
  31          #define M6      22
  32          #define M6_     23
  33          #define M7      24
  34          #define H1      25
  35          #define H1_     26
  36          #define H2      27
  37          #define H2_     28
  38          #define H3      29
  39          #define H4      30
  40          #define H4_     31
  41          #define H5      32
  42          #define H5_     33
  43          #define H6      34
  44          #define H6_     35
  45          #define H7      36
  46          */
  47          
  48          extern code unsigned char track[] = 
  49          { 
  50              29, 4, 1, 
  51              30, 4, 2,
  52              32, 4, 0, 
  53              34, 4, 2, 
  54              29, 4, 1,
C51 COMPILER V9.60.0.0   MUSIC                                                             04/29/2025 11:26:34 PAGE 2   

  55              30, 4, 2,
  56              32, 4, 0, 
  57              34, 4, 2,
  58              29, 4, 1, 
  59              30, 4, 2,
  60              32, 4, 0,
  61              34, 4, 2, 
  62              29, 4, 1,
  63              30, 4, 2,
  64              32, 4, 0, 
  65              34, 4, 2, 
  66              0, 0, 0 };
  67          
  68          //乐谱1
  69          extern unsigned char code Track1[] =
  70          {
  71              //音符,时值
  72          
  73              29,4,
  74              27,2,
  75              25,4,
  76              27,2,
  77              29,3,
  78              30,1,
  79              29,2,
  80              27,4,
  81              0,0,
  82          
  83              29,4,
  84              27,2,
  85              25,4,
  86              27,2,
  87              29,3,
  88              30,1,
  89              29,2,
  90              27,4,
  91              0,0,
  92          
  93              0xFF        //终止标志
  94          };
  95          
  96          extern unsigned char code Track2[] =
  97          {
  98              //音符,时值,track(0:无,1:sky,2:ground)
  99          
 100              25,2,
 101              29,2,
 102              32,6,
 103              34,2,
 104              32,2,
 105              29,2,
 106              25,2,
 107              29,2,
 108              27,4,
 109              25,2,
 110              27,2,
 111              29,4,
 112              0,0,
 113          
 114              25,2,
 115              29,2,
 116              32,6,
C51 COMPILER V9.60.0.0   MUSIC                                                             04/29/2025 11:26:34 PAGE 3   

 117              34,2,
 118              32,2,
 119              29,2,
 120              25,2,
 121              29,2,
 122              27,4,
 123              25,2,
 124              24,2,
 125              25,4,
 126              0,0,
 127          
 128              0xFF        //终止标志
 129          };
 130          
 131          unsigned int FreqTable[] = {
 132              0,
 133              63628,63731,63835,63928,64021,64103,64185,64260,64331,64400,64463,64528,
 134              64580,64633,64684,64732,64777,64820,64860,64898,64934,64968,65000,65030,
 135              65058,65085,65110,65134,65157,65178,65198,65217,65235,65252,65268,65283,
 136          };
 137          
 138          // 播放状态变量
 139          
 140          unsigned char FreqSelect;
 141          int duration;
 142          unsigned char Timer1h,Timer1l;
 143          volatile unsigned char* currentMusic = NULL;
 144          volatile unsigned int noteIndex = 0;
 145          
 146          void Music_Init(unsigned char* TrackData)
 147          {
 148   1          TMOD &= 0x0F;
 149   1          TMOD |= 0x10;
 150   1          TH1 = 0xFC;
 151   1          TL1 = 0x18;
 152   1          TF1 = 0;
 153   1          TR1 = 0;
 154   1          ET1 = 1;
 155   1          EA = 1;
 156   1          noteIndex = 0;
 157   1          currentMusic = TrackData;
 158   1      }
 159          
 160          void Timer1_Routine() interrupt 3
 161          {
 162   1          if (FreqTable[FreqSelect])  //如果不是休止符
 163   1          {
 164   2              // 设置定时器初值
 165   2              TL1 = Timer1l;
 166   2              TH1 = Timer1h;
 167   2              Buzzer = !Buzzer;  // 翻转蜂鸣器IO口
 168   2          }
 169   1      }
 170          
 171          void Music_PlayFullTrack()
 172          {
 173   1          if (!currentMusic)
 174   1          {
 175   2              Music_Stop();
 176   2              return;
 177   2          }
 178   1      
C51 COMPILER V9.60.0.0   MUSIC                                                             04/29/2025 11:26:34 PAGE 4   

 179   1          while (1)
 180   1          {
 181   2              // 检查终止标志
 182   2              if (currentMusic[noteIndex] == 0xFF)
 183   2              {
 184   3                  Music_Stop();
 185   3                  return;
 186   3              }
 187   2      
 188   2              // 播放当前音符
 189   2              FreqSelect = currentMusic[noteIndex];
 190   2              noteIndex++;
 191   2              duration = SPEED * currentMusic[noteIndex] / 4;
 192   2              noteIndex++;
 193   2              Timer1h = FreqTable[FreqSelect] / 256;
 194   2              Timer1l = FreqTable[FreqSelect] % 256;
 195   2      
 196   2              TR1 = 1;
 197   2              Delay(duration);
 198   2              TR1 = 0;
 199   2      
 200   2              // 短暂停顿防止音符粘连
 201   2              Delay(10);
 202   2          }
 203   1      }
 204          
 205          void Music_Stop(void) 
 206          {
 207   1          TR1 = 0;
 208   1          Buzzer = 0;
 209   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    306    ----
   CONSTANT SIZE    =    141    ----
   XDATA SIZE       =     84    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
